<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>BL√ÖHAJ finder</title>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="favicon-16x16.png"
		/>
		<meta name="msapplication-TileColor" content="#468293" />
		<!-- <meta name="msapplication-config" content="/assets/icons/browserconfig.xml"> -->
		<meta name="theme-color" content="#468293" />
		<meta name="description" content="Hourly BL√ÖHAJ finder map" />
		<meta property="og:url" content="https://blahaj.quest/" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="BL√ÖHAJ finder ü¶à" />
		<meta property="og:description" content="Hourly BL√ÖHAJ finder map" />
		<meta
			property="og:image"
			content="https://blahaj.quest/img/full-flipped.png"
		/>
		<meta property="twitter:url" content="https://blahaj.quest/" />
		<meta name="twitter:title" content="BL√ÖHAJ finder ü¶à" />
		<meta name="twitter:description" content="Hourly BL√ÖHAJ finder map" />
		<meta
			name="twitter:image"
			content="https://blahaj.quest/img/full-flipped.png"
		/>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
		<link
			href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
			rel="stylesheet"
		/>
		<script async defer src="https://buttons.github.io/buttons.js"></script>
		<style>
			* {
				margin: 0;
			}

			body {
				overflow: hidden;
				font-family: "Noto Sans", sans-serif;
				display: flex;
				flex-direction: column;
				height: 100%;
				width: 100%;
				position: absolute;
			}

			.maplibregl-popup-content {
				font-family: "Noto Sans", sans-serif;
				border-radius: 999px;
				padding: 12px 16px;
			}

			#map {
				width: 100%;
				height: 100%;
				top: 0;
				bottom: 0;
			}

			.header {
				height: 3em;
				display: flex;
				align-items: center;
				justify-content: flex-start;
				flex-direction: row;
				color: #fff;
				background-image: linear-gradient(
						0deg,
						rgba(29, 31, 33, 0.3),
						rgba(29, 31, 33, 0.3)
					),
					linear-gradient(0deg, #468293, #468293);
			}

			.icon {
				width: auto;
				height: 200%;
			}

			.title {
				font-size: 1rem;
				margin-left: 16px;
				margin-top: -4px;
			}

			.title a {
				text-decoration: none;
				color: #fff;
			}

			.settings {
				position: fixed;
				margin: auto;
				top: 4em;
				left: 1em;
				display: flex;
				flex-direction: column;
				align-items: flex-start;
			}

			#style-picker {
				border-radius: 999px;
				padding: 0 12px;
				background-color: #fff;
				box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
				font-size: 0.8em;
				display: flex;
				align-items: center;
				justify-content: center;
				height: 32px;
			}

			#style-picker label {
				margin-left: 4px;
			}

			#style-picker .spacer {
				border-left: solid 2px rgba(0, 0, 0, 0.1);
				margin: -16px 8px;
				height: 32px;
			}

			.show-buttons {
				border-radius: 16px;
				padding: 6px 12px;
				background-color: #fff;
				box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
				font-size: 0.8em;
				margin-top: 8px;
				display: flex;
				align-items: flex-start;
				flex-direction: column;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<img class="icon" src="img/full-flipped.png">
			<h1 class="title">
				<a href="https://www.ikea.com/us/en/p/blahaj-soft-toy-shark-90373590/">BL√ÖHAJ finder</a>
			</h1>
			<p style="margin-left: 32px">
				Last updated: <b id="updated"></b>
				<span style="opacity: 0.6">(updates hourly)</span>
			</p>
			<p style="margin-left: 32px">
				<b><span id="total-stores"></span> stores</b> indexed
			</p>
			<p style="margin-left: 32px">
				<b><span id="total-blahaj"></span> bl√•hajar</b> swimming
			</p>
			<div style="flex-grow: 1"></div>
			<a
				href="https://maki.cafe"
				style="color: #fff; text-decoration: none; margin-right: 16px"
			>
				Made by <b>Maki</b>
			</a>
			<span style="margin-right: 12px">
				<a
					class="github-button"
					href="https://github.com/makitsune/blahaj-finder"
					data-color-scheme="no-preference: light; light: light; dark: light;"
					data-size="large"
					data-show-count="true"
					aria-label="Star makitsune/blahaj-finder on GitHub"
				>
					Star
				</a>
			</span>
		</div>
		<div id="map"></div>
		<div class="settings">
			<div id="style-picker"></div>
			<div class="show-buttons">
				<div>
					<input
						type="checkbox"
						id="show-markers"
						autocomplete="off"
					/>
					<label for="show-markers">Show bl√•hajar</label>
				</div>
				<div>
					<input
						type="checkbox"
						id="show-heatmap"
						autocomplete="off"
					/>
					<label for="show-heatmap">Show heatmap</label>
				</div>
				<div>
					<select id="product-select">
					</select>
				</div>
			</div>
		</div>
		<script>
			let my_notify = [];

			function urlBase64ToUint8Array(base64String) {
				var padding = '='.repeat((4 - base64String.length % 4) % 4);
				var base64 = (base64String + padding)
					.replace(/\-/g, '+')
					.replace(/_/g, '/');
			
				var rawData = window.atob(base64);
				var outputArray = new Uint8Array(rawData.length);
			
				for (var i = 0; i < rawData.length; ++i) {
					outputArray[i] = rawData.charCodeAt(i);
				}
				return outputArray;
			}

			async function registerServiceWorker() {
				const registration = await navigator.serviceWorker.register('./service-worker.js', {
					scope: `${location.protocol}//${location.hostname}${location.pathname}`
				  }).catch(function (err) {
					console.error('Unable to register service worker.', err);
				  });
				console.log('Service worker successfully registered.');
				return registration;
			}

			function askPushPermission() {
				return new Promise(function (resolve, reject) {
				  const permissionResult = Notification.requestPermission(function (result) {
					resolve(result);
				  });
			  
				  if (permissionResult) {
					permissionResult.then(resolve, reject);
				  }
				}).then(function (permissionResult) {
				  if (permissionResult !== 'granted') {
					throw new Error("We weren't granted permission.");
				  }
				});
			}

			async function subscribeUserToPush() {
				const serverKey = await (await fetch("./vapidPublic")).text();
				const registration = await registerServiceWorker();
				const subscribeOptions = {
					userVisibleOnly: true,
					applicationServerKey: urlBase64ToUint8Array(serverKey),
				};
			
				const pushSubscription = await registration.pushManager.subscribe(subscribeOptions);
				console.log(
					'Received PushSubscription: ',
					JSON.stringify(pushSubscription),
				);
				return pushSubscription;
			}

			async function sendSubscriptionToBackEnd(subscription) {
				const response = await fetch('./api/save-subscription/', {
				  method: 'POST',
				  headers: {
					'Content-Type': 'application/json',
				  },
				  body: JSON.stringify({
					push: subscription,
				  })
				});
				if (!response.ok) {
					throw new Error('Bad status code from server.');
				}
				const responseData = await response.json();

				if (!(responseData.data && responseData.data.success)) {
					throw new Error('Bad response from server.');
				}
			}

			async function getSubscription() {
				const reg = await registerServiceWorker();
				const sub = await reg.pushManager.getSubscription();
				return sub;
			}

			async function api_get_notify(push, retry = false) {
				const resp = await fetch("./api/sub-get-notify", {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						endpoint: push.endpoint
					})
				});

				if(resp.status == 404 && !retry) {
					await sendSubscriptionToBackEnd(push);
					return await api_get_notify(push, true)
				}

				const body = await resp.json();
				return body;
			}

			async function api_set_notify(push, notify, retry = false) {
				const resp = await fetch("./api/sub-set-notify", {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						endpoint: push.endpoint,
						notify: notify,
					}),
				});

				if(resp.status == 404 && !retry) {
					await sendSubscriptionToBackEnd(push, true);
				}

				const body = await resp.json();
				return body;
			}

			async function subscribeStore(product, store) {
				await askPushPermission();
				let push = await getSubscription();
				if(!push) {
					console.log("registering new subscription")
					push = await subscribeUserToPush();
					await sendSubscriptionToBackEnd(push);
				}

				my_notify = await api_get_notify(push);
				if(!my_notify) {
					await sendSubscriptionToBackEnd(push);
					my_notify = await api_get_notify(push);
				}
				my_notify.push({
					product: product,
					store: store,
				});
				await api_set_notify(push, my_notify);
			}

			async function unsubscribeStore(product, store) {
				await askPushPermission();
				const push = await getSubscription();
				if(push) {
					my_notify = await api_get_notify(push);
					my_notify = my_notify.filter(e => !(e.store == store && e.product == product));
					await api_set_notify(push, my_notify);
				}
			}

			(async () => {
				const push = await getSubscription();
				if(push) {
					console.log("getting notifications");
					my_notify = await api_get_notify(push);
				} else {
					console.log("not subscribed");
				}
			})();

			const mapLoadImage = url =>
				new Promise((resolve, reject) => {
					map.loadImage(url, function (error, image) {
						if (error) return reject(error);
						return resolve(image);
					});
				});

			const maptilerKey = "";

			const styles = [
				//[
				//	"Self-hosted",
				//	"https://tileserver.cutelab.space/styles/streets/style.json",
				//],
				["OpenStreetMap", "styles/osm-mapnik.json"],
				// [
				// 	"MapTiler (might not work)",
				// 	"https://api.maptiler.com/maps/streets/style.json?key=" +
				// 		maptilerKey,
				// ],
				["Stamen Watercolor", "styles/stamen-watercolor.json"],
			];

			const stylePicker = document.getElementById("style-picker");
			styles
				.map(([name, url], i) => {
					const input = document.createElement("input");
					input.type = "radio";
					input.id = "style-" + name;
					input.name = "style";
					input.autocomplete = "off";
					if (i == 0) input.setAttribute("checked", "");

					input.addEventListener("click", () => {
						map.setStyle(url);
					});

					const label = document.createElement("label");
					label.setAttribute("for", "style-" + name);
					label.textContent = name;

					const div = document.createElement("div");
					div.appendChild(input);
					div.appendChild(label);

					return div;
				})
				.forEach((el, i) => {
					if (i != 0) {
						const span = document.createElement("span");
						span.className = "spacer";
						stylePicker.appendChild(span);
					}

					stylePicker.appendChild(el);
				});

			const toggleableLayers = ["markers", "heatmap"];
			const layerVisibility = { markers: true, heatmap: true };

			const map = new maplibregl.Map({
				container: "map",
				style: styles[0][1],
				center: [15, 20],
				zoom: 1.8,
			});

			map.addControl(new maplibregl.NavigationControl());

			map.dragRotate.disable();
			map.touchZoomRotate.disableRotation();

			map.on("style.load", () => {
				onMapLoad();
			});

			map.on("mouseenter", "markers", function () {
				map.getCanvas().style.cursor = "pointer";
			});

			map.on("mouseleave", "markers", function () {
				map.getCanvas().style.cursor = "";
			});

			async function onMapLoad() {
				const res = await fetch("blahaj.json?" + Date.now());
				const blahajData = await res.json();
				const product_names = Object.keys(blahajData.data);
				
				const updated = new Date(blahajData.updated);
				document.getElementById("updated").textContent =
					updated.toLocaleString();

				const markerIconsSize = 2;
				const markerIcons = {
					opaque: ["marker1", "marker2"],
					faded: ["marker1-faded", "marker2-faded"],
				};

				for (const name of [...markerIcons.opaque, ...markerIcons.faded]) {
					map.addImage(
						name,
						await mapLoadImage(
							"img/marker-icons/48/" + name + ".png",
						),
					);
				}

				function marker_click(e) {
					const f = e.features[0];
					const p = f.properties;
					const coordinates = f.geometry.coordinates.slice();
					const div = document.createElement("div");
					
					const description = document.createElement("span");
					description.innerText = `${p.store} has ${p.quantity} ${p.product}`;
					div.appendChild(description);

					const subscribe = document.createElement("button");

					if(my_notify.find(e => e.product == p.product && e.store == p.store)) {
						subscribe.onclick = () => {
							unsubscribeStore(p.product, p.store);
						}
						subscribe.innerText = "remove subscription";
					} else {
						subscribe.onclick = () => {
							subscribeStore(p.product, p.store);
						}
						subscribe.innerText = "subscribe for restocks";
					}
					div.appendChild(subscribe);

					new maplibregl.Popup()
						.setLngLat(coordinates)
						.setDOMContent(div)
						.addTo(map);
				}

				function add_product(name) {
					map.addSource(name, {
						type: "geojson",
						data: {
							type: "FeatureCollection",
							features: blahajData.data[name].map(store => ({
								type: "Feature",
								properties: {
									icon: (store.quantity == 0 ? markerIcons.faded : markerIcons.opaque)[Math.floor(Math.random() * markerIconsSize)],
									weight: store.quantity / 32,
									store: store.name,
									product: name,
									quantity: store.quantity,
								},
								geometry: {
									type: "Point",
									coordinates: [store.lng, store.lat],
								},
							})),
						},
					});

					map.addLayer({
						id: name+"_heatmap",
						source: name,
						type: "heatmap",
						paint: {
							"heatmap-weight": {
								property: "weight",
								type: "identity",
							},
							"heatmap-radius": 40,
						},
					});

					map.addLayer({
						id: name+"_markers",
						source: name,
						type: "symbol",
						layout: {
							"icon-image": ["get", "icon"],
							"icon-size": 1,
							"icon-overlap": "always",
						},
					});

					map.on("click", name+"_markers", e => {
						marker_click(e);
					});
				}

				function set_map_product_data() {
					const product_name = product_select.value;
					const product = blahajData.data[product_name];
					document.getElementById("total-stores").textContent =
						product.length.toLocaleString("en-US");

					document.getElementById("total-blahaj").textContent =
						product.reduce((a, b) => a + b.quantity, 0).toLocaleString("en-US");

					for(const _product_name of product_names) {
						map.setLayoutProperty(
							_product_name+"_heatmap",
							"visibility",
							(layerVisibility["heatmap"] && product_select.value == _product_name) ? "visible" : "none",
						);

						map.setLayoutProperty(
							_product_name+"_markers",
							"visibility",
							(layerVisibility["markers"] && product_select.value == _product_name) ? "visible" : "none",
						);
					}
				}

				const product_select = document.getElementById("product-select");
				for(const product_name of product_names) {
					const opt = document.createElement("option");
					opt.innerText = product_name;
					opt.value = product_name;
					product_select.appendChild(opt);
					add_product(product_name);
				}
				product_select.onchange = (e) => {
					set_map_product_data();
				}
				set_map_product_data();

				for (const name of toggleableLayers) {
					const el = document.getElementById("show-" + name);
					el.checked = layerVisibility[name];
					el.addEventListener("change", e => {
						layerVisibility[name] = e.target.checked;
						set_map_product_data();
					});
				}
			}
		</script>
	</body>
</html>
